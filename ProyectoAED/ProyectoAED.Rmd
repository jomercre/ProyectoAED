---
title: Proyecto de AED
author:
  - name: Joan Merlos Cremades
    affil: 1,*
  - name: Héctor Torres Muñoz
    affil: 2
affiliation:
  - num: 1
    address:
      Universitat de València
    email: joanmer@alumni.uv.es
  - num: 2
    address:
      Universitat de València
    email: hecto2@alumni.uv.es
correspondence:
  joanmer@alumni.uv.es
# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  Proyecto de la asignatura Ánalisis exploratorio de datos del Máster en Ciencia de datos de la Universitat de València.
abstract: |
  En las siguientes páginas, se encuentra un estudio exploratorio de los datos correspondientes a la inserción laboral de los estudiantes universitarios que finalizaron su grado durante el curso 2013-2014, dichos datos fueron recogidos por el Instutito Nacional de Estadística (INE) y se pueden descargar de forma libre accediendo al siguiente enlace \url{https://www.ine.es/ftp/microdatos/eilu/datos_2019.zip}). Dicho análisis exploratorio consistirá en transformar los datos a sus correspondientes tipos, renombrar los factores para que tengan nombres representativos, estudiar las posibles relaciones entre las diferentes variables e imputar datos de interés.
keywords: |
  Análisis exploratorio de datos, INE, Inserción laboral.
bibliography: mybibfile.bib
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r, echo = FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```


# Introducción

En la carpeta de datos original, se pueden observar dos archivos de datos CSV diferentes. El archivo que se va a proceder a analizar es el de la gente que se graduó en una universidad española durante el curso 2013-2014 (EILU_GRAD_2019.csv). El otro archivo corresponde a la gente que obtuvo un máster en el curso 2013-2014, por lo que no será objeto de nuestro estudio. Habiendo aclarado ya el conjunto de datos a utilizar podemos proceder a importar las librerías que nos permitirán analizarlo, limpiarlo y estudiarlo.

```{r}
pacman::p_load(readr,dplyr,ggplot2,vcd,patchwork,knitr)
```


# Importación y limpieza de datos 

En este apartado vamos a proceder a importar el archivo de datos con el que vamos a trabajar. Para ello primero debemos de adivinar su codificación mediante el uso de la función __guess_encoding__.
```{r}
# Adivinamos la codificación 

guess_encoding("./data/EILU_GRAD_2019.csv")
```

Una vez que sabemos que la codificación de nuestros datos es ASCII, podemos proceder a importarlos teniendo en cuenta que estan en formato CSV y que los diferentes valores se encuentran separados por tabulador.
```{r,message=FALSE,warning=FALSE}
df_raw <- read_delim("./data/EILU_GRAD_2019.csv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE, locale = locale(encoding = "ASCII"))
```

El dataframe importado tiene una longitud de ```r ncol(df_raw)``` variables, así que para falicitar nuestro estudio nos quedaremos únicamente con las variables principales que afectan a los estudios, la situación laboral y el sueldo de los diferentes individuos. Para conocer que representa cada una de las distintas variables debemos acudir al codebook de los metadatos, este viene dado por el archivo xlsx denominado __dr_EILU_GRAD_2019.xlsx__. Cabe destacar que en el proyecto de R donde se encuentra este documento pdf también hemos añadido el archivo para que cualquier persona pueda identificar las variables sin necesidad de abrir el archivo original de metadatos.
```{r}
var <- c('IDENT','SEXO','RAMA','T_UNIV','EST_B17_M1','EST_B17_M2','EST_B17_M3',
         'EST_B21','EST2_SA','IDIOMAS','TRBPRN1','TR_SUELDO','HATR_E11')

df <- df_raw[var]
```

Una vez que ya tenemos seleccionadas las variables con las que vamos a realizar nuestro estudio debemos pasar cada una de ellas a su respectivo tipo. Dicha tarea se vuelve un poco tediosa debido a que las diferentes variables de tipo factor han sido codificadas mediante índices numéricos, para saber que simboliza cada uno de estos números debemos, otra vez, acudir al codebook de los metadatos. Una vez que podemos comprender que significa cada número debemos convertir las diferentes columnas en factor mediante la función __factor__ introduciendo en el parámetro __levels__ los índices correspondientes a cada nivel del factor y en la parámetro __labels__ el nuevo nombre que queremos asociar a cada nivel del factor, el cual debe ser los suficientemente indicativo para poder interpretarlo más adelante en las distintas gráficas experimentales que se realizaran. Cabe destacar que todo este proceso se encuentra en el documento Rmd asociado, ya que consideramos redundante introducirlo en este informe.
```{r, echo=FALSE}
df$SEXO <- factor(df$SEXO, levels = c(1,2), labels = c('Hombre', 'Mujer'))

codi_rama <- c(1, 2, 3, 4, 5)
desc_rama <- c("Artes y humanidades", "Ciencias", 
               "Ciencias sociales y jurídicas", "Ingeniería y arquitectura",
               "Ciencias de la salud")

df$RAMA <- factor(df$RAMA, levels=codi_rama, labels=desc_rama)

codi_tipu <- c(1, 2, 3, 4)
desc_tipu <- c("Universidad Pública presencial", "Universidad Pública a distancia", "Universidad Privada presencial", "Universidad Privada a distancia")

df$T_UNIV <- factor(df$T_UNIV, levels=codi_tipu, labels=desc_tipu)

# 9 = NA

codi_idi <- c("0", "1", "2", "3", "4", "5")
desc_idi <- c("0", "1", "2", "3", "4", "5 o más")

df <- df %>% mutate(IDIOMAS = ifelse(IDIOMAS == "9",NA, IDIOMAS))

df$IDIOMAS <- factor(df$IDIOMAS, levels=codi_idi, labels=desc_idi)

codi_empl <- c(1, 2, 3)
desc_empl <- c("Trabajando", "En desempleo", "Inactivo")

df$TRBPRN1 <- factor(df$TRBPRN1, levels=codi_empl, labels=desc_empl)

codi_sueldo <- c("1", "2", "3", "4", "5", "6", "7")
desc_sueldo <- c("Menos de 700 euros",
                                  "De 700 a 999 euros",
                                  "De 1.000 a 1.499 euros",
                                  "De 1.500 a 1.999 euros",
                                  "De 2.000 a 2.499 euros",
                                  "De 2.500 a 2.999 euros",
                                  "De 3.000 euros en adelante")

df <- df %>% mutate(TR_SUELDO = ifelse(TRBPRN1 == "9",NA, TR_SUELDO))

df$TR_SUELDO <- factor(df$TR_SUELDO, levels=codi_sueldo, labels=desc_sueldo)

# 9 = NA

codi_tiempo1 <- c("0", "1", "2", "3", "4", "5", "6")
desc_tiempo1 <- c("Continuó (+ 6 meses)", "< 3 meses", "3-6 meses", "6 meses-1 año", "1-1.5 años", "1.5-2 años", ">= 2 años")

df <- df %>% mutate(HATR_E11 = ifelse(TRBPRN1 == "9",NA, HATR_E11))

df$HATR_E11 <- factor(df$HATR_E11, levels=codi_tiempo1, labels=desc_tiempo1)
```

Antes de pasar al siguiente apartado, vamos a intentar convertir todas las variables que nos indican la rama de los estudios realizados por cada individuo en una sola. La rama que nos aporta la rama de estudio del primer estudio universitario realizado por el individuo se denomina RAMA. No osbtante, después tenemos más variables que nos indican la rama de los másteres realizados por el individuo o la rama del doctorado más importante. Para reducir todas estas múltiples variables a una sola vamos a crear la variable URAMA, la cual nos va indicar la rama del estudio más elevado realizado por el individuo, es decir, la rama de los últimos estudios realizados. Cabe destacar que vamos a ignorar la columna dedicada a los estudios del del tipo MIR, ya que todo aquel que se encuentre realizándolo o ya lo haya realizado necesariamente debe haber realizado una carrera o máster de la rama de ciencias de la salut. Por tanto, no es redundante conocer esa información para crear la columna con la rama del último estudio realizado.

Para crear la variable URAMA simplemente debemos tener en cuenta que cuando el individuo no ha dado información sobre el estudio o directamente no ha realizado dicho estudio la columna aparecera como NA, así que vamos estudiando que columnas continen datos no faltantes empezando por los doctorados, siguiendo por los másteres y terminando en los grados o diplomaturas.
```{r}
df <- df %>% 
  mutate(URAMA = ifelse(!is.na(EST_B21), EST_B21, 
    ifelse(!is.na(EST_B17_M3), EST_B17_M3,
        ifelse(!is.na(EST_B17_M2), EST_B17_M2,
          ifelse(!is.na(EST_B17_M1), EST_B17_M1,
                 RAMA)))))

codi_urama <- c(1, 2, 3, 4, 5)
desc_urama <- c("Artes y humanidades", "Ciencias", 
                "Ciencias sociales y jurídicas", "Ingeniería y arquitectura",
                "Ciencias de la salud")

df$URAMA <- factor(df$URAMA, levels=codi_urama, labels=desc_urama)
```

Una vez se ha obtenido la columna URAMA podemos eliminar del dataframe las variables con información sobre las ramas de los másteres o la columna que contiene la rama del doctorado más importante.
```{r}
df <- df %>% select(-c('EST_B17_M1','EST_B17_M2','EST_B17_M3',
                       'EST_B21','EST2_SA'))
```

# Inspección de datos faltantes

En este apartado, vamos a proceder a estudiar los datos faltantes en cada columna del dataframe con información, es decir, vamos a obviar la columna con el identificador.

```{r tab1, echo=FALSE}
nasum <- c()

for (i in 1:(length(names(df))-1)){
  nasum[i] <- sum(is.na(df[i+1]))
}
  

dfT1 <- data.frame('Variable' = names(df)[2:length(names(df))],
                 'Número de datos faltantes' = nasum,check.names = FALSE)

kable(dfT1, format = "latex",booktabs = TRUE,
  caption = "Cantidad de Na's en función de la variable",
  align = 'l|c', longtable = TRUE,linesep = "")
```

Como podemos observar las únicas columnas con datos faltantes son IDIOMAS, TR_SUELDO y HATR_E11. La variable con más datos faltantes es TR_SUELDO con un ```r round(sum(is.na(df$TR_SUELDO))/nrow(df)*100,2)``` % de datos con NA. No obstante, no todos ellos son datos que no han sido rellenados, ya que puede darse el caso de que la persona no esté actualmente trabajando y, por tanto, no haya rellenado a drede la casilla de TR_Sueldo. Para observar cuales son en realidad nuestros datos faltantes procedemos a observar el número de NA's de la variable TR_SUELDO una vez hemos eliminado aquellas personas que no se encuentran trabajando.
```{r tab2, echo=FALSE}
dfAc <- df %>% filter(TRBPRN1 != 'Trabajando')

NAs <- c(sum(is.na(df$TR_SUELDO)),sum(is.na(dfAc$TR_SUELDO)))

dfT2 <- data.frame('Variable' = c('TR_SUELDO','TR_SUELDO'),
                  'Cálculo' = c('Con todos los datos',
                                'Con la gente activa laboralmente'),
                  'Número de datos faltantes' = NAs,
                  check.names = FALSE)

kable(dfT2, format = "latex",booktabs = TRUE,
  caption = "Cantidad de Na's en la variable TR.SUELDO cuando se elimina la cantidad de gente que no está activa laboralmente",
  align = 'l|c|c', longtable = TRUE,linesep = "")
```

Como podemos observar hay aproximadamente 1000 valores NA que pertenecen a la población no activa laboralmente, la cual es lógico que no tenga un salario. No obstante, los otros 3800 datos con NA no parecen seguir ninguna lógica. Por ello intentaremos relacionar la variable sueldo con alguna otra variable del conjunto que no contenga datos faltantes para así conseguir imputar dichos datos.

# Gráficas exploratorias

En este apartado, vamos a proceder a realizar diferentes gráficas de barras para observar como se separan los datos en función de las variables categóricas que utilicemos. 

Para empezar, vamos a hacer dos gráficos de barras con la variable RAMA y URAMA para observar si hay mucha discrepancia entre ambas variables.
```{r figT1, echo=FALSE,fig.cap="Gráfico de barras de RAMA/URAMA coloreado con SEXO",fig.align = 'center', out.width = "0.6\\linewidth"}
p1 <- ggplot(data=df, aes(x = RAMA)) + geom_bar(aes(fill=SEXO)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) + 
  scale_y_continuous(limits = c(0, 16000))

p2 <- ggplot(data=df, aes(x = URAMA)) + geom_bar(aes(fill=SEXO)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
  scale_y_continuous(limits = c(0, 16000))

p1+p2
```
Como podemos observar los dos gráficos son muy similares, lo cual tiene sentido, ya que la gente suele realizar empezar estudios que tengan relación con sus estudios ya completados. A partir de estos gráficos también se observa como hay ramas como ingeniería y arquitectura donde predominan los hombres y otras como Ciencias sociales y jurídicas donde los alumnos son mayoritariamente mujeres.


Para proseguir graficamos la situación laborales de las personas analizadas en función del tipo de universidad en la que realizaron su primer grado.
```{r figT2,echo=FALSE, fig.cap="Gráfico de barras de la situación laboral coloreado con el tipo de universidad",fig.align = 'center', out.width = "0.6\\linewidth"}
ggplot(data=df, aes(x = TRBPRN1)) + geom_bar(aes(fill=T_UNIV)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
  scale_fill_brewer(palette = "YlOrRd")
```
En el anterior gráfico se puede apreciar como prácticamente toda la gente que se ha sometido a la encuesta se encuentra trabajando, en concreto tenemos un ```r round(nrow(dfAc)/nrow(df)*100,2)``` % de gente laboralmente activa. Por otro lado, se observa como la mayor parte de la gente a estudiado en una universidad pública presencial seguida de la universidad privada presencial.

Ahora gráficamos el tiempo transcurrido hasta encontrar trabajo en función del tipo de RAMA del estudio más importante realizado.
```{r figT3,echo=FALSE, fig.cap="Gráfico de barras del tiempo transcurrido hasta que empezo a trabajar coloreado con el tipo de RAMA del estudio más importante realizado",fig.align = 'center', out.width = "0.6\\linewidth"}
ggplot(data=df, aes(x = HATR_E11)) + geom_bar(aes(fill=URAMA)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  scale_fill_brewer(palette = "Purples")
```

La anterior gráfica nos permite apreciar como la mayor parte de la gente tiende a continuar en el mismo trabajo que tenía después de finalizar la universidad. Podemos destacar que la gráfica presenta una tendencia descendiente, de modo que cuanto más tiempo pasa es menos probable que la gente se encuentre sin trabajo. No osbtante, observamos un aumento anómalo en la última columna con datos no vacíos, lo cual podría estar relacionado con la realización de estudios de post-grado como másteres o doctorados donde uno no está trabajando directamente pero ya ha finalizado su grado o licenciatura. Por otro lado, no parece haber una relación entre el tipo de la rama y el tiempo que se tarda en encontrar trabajo, ya que todas las columnas presentan proporciones similares de todos las ramas.

Para proseguir vamos a graficar la rama del estudio más elevado en función de la situación laboral.
```{r figT4,echo=FALSE, fig.cap="Gráfico de barras normalizado de la rama del estudio más elevado coloreado con la situación laboral",fig.align = 'center', out.width = "0.6\\linewidth"}
ggplot(df, aes(x= URAMA)) + geom_bar(position = "fill",aes(fill=TRBPRN1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
  scale_fill_brewer(palette = "Greens")
```

Como podemos observar en la anterior gráfica, hay una cantidad mayor de gente que no se encuentra trabajando en las ramas de artes y humidades y ciencias sociales y ciencias jurídicas. No obstante, la diferencia con la cantidad de gente que no trabaja en las otras ramas es muy pequeña.


A continuación, vamos a proceder a realizar diferentes gráficos de barras del número de idiomas en función de la situación laboral, los cuales además estarán coloreados por el sexo.
```{r figT5,echo=FALSE, fig.cap="Gráficos de barras de el número de idiomas en función de la situación laboral y coloreado por el sexo",fig.align = 'center', out.width = "0.6\\linewidth"}
ggplot(df, aes(x=IDIOMAS)) + geom_bar(aes(fill=SEXO)) + facet_wrap(~TRBPRN1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))
```

Observamos como en todos los casos la columna con mayor peso es 1, lo cual nos indica que la gente suele enseñarse un único idioma diferente a los idiomas maternos. Dicha relación tiene sentido, ya que actualmente la gente suele centrarse en estudiar el inglés y dejar el resto de idiomas más de lado. También se puede notar que la segunda columna con más cantidad de datos es la de dos idiomas, dentro de la cual predomina el sexo femenino. Por otro lado, no parece haber una relación directa entre la cantidad de idiomas diferentes del materno que conoce el individuo con la situación laboral que este ostenta.

# Imputación de datos faltantes

Queremos imputar los valores de la variable con el sueldo para aquellas personas que se encuentran activas, para ello lo que vamos a hacer va a ser primero aplicar el test del $\chi^2$ a la combinación de la variable TR_SUELDO con el resto de variables, evitando las variables IDENT porque no tiene sentido relacionarla con el identificador y la variable TRBPRN1 porque si eliminamos los NA's de la variable TR_SUELDO, aquellas personas que no estan laboralmente activas se eliminan y no tiene sentido realizar la table de contingencia porque dos columnas valen siempre 0.
```{r, echo=FALSE}
colNam <- names(df %>% select(-IDENT,-TR_SUELDO, -TRBPRN1, -RAMA))
dfAUX2 <- df %>% na.omit()

p <- c()
V <- c()

sueldo <- c()

for (i in 1:length(colNam)){
  
  tabla <- table(dfAUX2$TR_SUELDO, dfAUX2[[colNam[i]]])
  
  test <- chisq.test(tabla)
  
  p[i] <- test$p.value
  V[i] <- (test$statistic / (sum(tabla) * (min(dim(tabla)) - 1)))**0.5
  
  sueldo[i] <- 'TR_SUELDO'
}

p <- sprintf("%.2e", p)
V <- sprintf("%.2e", V)

dfT3 <- data.frame('Variable 1' = sueldo,
                   'Variable 2' = colNam,
                  'p-valor' = p,
                  'V de Cramer' = V,
                  check.names = FALSE)

kable(dfT3, format = "latex",booktabs = TRUE,
  caption = "p-valor y V de Cramer para el sueldo",
  align = 'c', longtable = TRUE,linesep = "")
```


Cuando el valor de p obtenido en dicho test es menor que 0.05 podemos concluir que hay una relación entre las dos variables categóricas sobre las que se ha aplicado el test, por tanto podemos decir que todas las variables se encuentran relacionadas en mayor o menor medida. La significancia estadística de dicha relación nos la de el valor del V de Cramer, dicho estadístico consiste en una normalización del parámetro $\chi^2$ de modo que un mayor valor del V de Cramer quiere decir que hay una mayor significancia estadística entre las variables. Ante dicho descubrimiento podríamos pensar que utilizar la variable SEXO es lo mejor. No obstante, esto no tiene ningún sentido, ya que teóricamente ambos sexos tienen las mismas oportunidades y deberían tener las mismas oportunidades de forma laboral. Ante este hecho vamos a proceder a utilizar la variable URAMA para realizar la imputación de los datos. Cabe destacar que el V de Cramer también nos muestra que la variable URAMA es la que tiene mayor significancia estadística después de la variable SEXO.

Poner cosas de imputacion


Preparación de la variable TR_SUELDO, dado que esta variable presenta una cantidad elevada de datos faltantes además de una codificación que complica trabajar con los datos. 

Antes de imputar es necesario verificar si podemos realizar imputación condicional obervando si hay relación entre las variables TR_SUELDO y RAMA. Para ello realizamos el test Chi-Cuadrado


```{r}
tabla <- table(df$RAMA, df$TR_SUELDO)
print(tabla)

chi_test <- chisq.test(tabla)
print("RESULTADO TEST CHI-CUADRADO") 
print(chi_test)
```

El resultado del test chi-cuadrado confirma que las variables están estadísticamente relacionadas y por ende pueden usarse para imputación condicional.

A continuación se realiza la imputación condicional de la variable *TR_SUELDO* empleando la moda, el objetivo es completar los valores faltantes en la variable, la cual corresponde con el rango salarial de las personas encuestadas. Para garantizar la coherencia estadística se realiza imputación solamente en individuos que constan como "Trabajando", además se emplea la variable *RAMA* de manera condicional, usando como criterio de sustitución la moda salarial de cada rama. 

El proceso se estructura en fases: preparación de las variables, detección de los valores faltantes (NA), cálculo de la moda, imputación y verificación.

En primer lugar convertimos las variables *RAMA* y *TR_SUELDO* en factores ordenados. Esto es obligatorio ya que ambas variables son categóricas y presentan un número finito de niveles. Además, destacar la conversión de *TR_SUELDO* a factor ordinal ya que los rangos salariales deben tener un orden lógico, en este caso de menor a mayor. Esto permitirá ordenar correcatmente las categorías y realizar comparaciones válidas entre niveles.

En segundo lugar, antes de hacer la imputación, se lleva a cabo un cuantificación del número de observaciones faltantes en *TR_SUELDO* y como estan distribuidas en cada rama. El resultado obtenido fue de 5266 NAs en total, habiendo una mayor proporción de NA en la rama "Ciencias sociales y jurídicas". 

A continuación, se calcula la moda salarial, la cual corresponde con el nivel de sueldo más frecuente dentro de cada rama de estudio. Para calcularla se han considerado únicamente las siguiente obervaciones:
+ La persona se encuentra trabajando actualmente.
+ El valor de *TR_SUELDO* no es NA.
+ El valor de *TR_SUELDO* no corresponde a la categoría "NS/NC", la cual no es imputable.

El cálculo de la moda se lleva a cabo usando funciones de la librería *dplyr*: group_by(RAMA) agrupa los registros por rama, count() contabiliza la frecuencia de cada nivel salarial dentro del grupo, y slice_max() selecciona el valor más frecuente (la moda) en cada rama. El resultado es una tabla auxiliar que asocia a cada rama su correspondiente “moda salarial”.

Cuando la moda salarial de cada rama está calculada, se puede comenzar la imputación. Empleando la función *left_join()*, se une la tabla de modas al conjunto de datos original a través de la variable *RAMA*. Luego, usando *mutate()* se reemplazan los valores NA con las condiciones *ifelse(TRBPRN1 == "Trabajando" & is.na(TR_SUELDO)*, es decir, que esté trabajando y que el valor sea NA, que es lo que se debe imputar. Tras la imputación, *TR_SUELDO* se reconvierte nuevamente en factor ordenado, asegurando que la variable conserva la estructura ordinal orginial y también las etiquetas.

Por útlimo, es posible verificar los resultados y la efectividad del proceso de imputación. Se oberva una imputación satisfactoria con reducción de 5266 casos de NA en trabajador a 0 NA presentes. No obstante, es necesario destacar todavía la presencia de 4527 valores faltantes, los cuales corresponden con NA de personas que no trabajan. Además, de acuerdo con el resumen de frecuencias, se muestra un distribución coherente con la esperada para variables salariales: rangos más comunes entre 1000 y 1999 euros y no se registran casos en la categoría "NS/NC" confirmando que se excluyó correctamente del proceso.

```{r}
#imputación de tr_sueldo usando la moda y dplyr y count().

library(dplyr)
library(ggplot2)

#convertimos variabls a factores para trabajar bien con ello

df$RAMA <- factor(df$RAMA,
                  levels = c("Artes y humanidades",
                             "Ciencias",
                             "Ciencias sociales y jurídicas",
                             "Ingeniería y arquitectura",
                             "Ciencias de la salud"))

df$TR_SUELDO <- factor(df$TR_SUELDO,
                       levels = c("Menos de 700 euros",
                                  "De 700 a 999 euros",
                                  "De 1.000 a 1.499 euros",
                                  "De 1.500 a 1.999 euros",
                                  "De 2.000 a 2.499 euros",
                                  "De 2.500 a 2.999 euros",
                                  "De 3.000 euros en adelante",
                                  "NS/NC"),
                       ordered = TRUE)

#chequear valores na en el dataset

print("Número de valores faltantes en TR_SUELDO")
sum(is.na(df$TR_SUELDO))

print("Distribución de NAs por rama")
print(table(df$RAMA, is.na(df$TR_SUELDO)))

#calculamos la moda sin tener en cuenta na y ns/nc

moda_por_rama <- df %>%
  filter(TRBPRN1 == "Trabajando",
         !is.na(TR_SUELDO),
         TR_SUELDO != "NS/NC") %>%
  group_by(RAMA) %>% 
  count(RAMA, TR_SUELDO, sort = TRUE) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  transmute(RAMA,
            moda_sueldo = as.character(TR_SUELDO))  # nos quedamos con el texto

#imputación en este caso con la moda 

df <- df %>%
  left_join(moda_por_rama, by = "RAMA") %>%
  mutate(
    TR_SUELDO = ifelse(
      TRBPRN1 == "Trabajando" & is.na(TR_SUELDO),
      moda_sueldo,                      # usamos la moda de su rama
      as.character(TR_SUELDO)           # dejamos el valor actual (o NA si no aplica)
    )
  ) %>%
  select(-moda_sueldo)

#convertimos tr_sueldo a factor ordenado otra vez
df$TR_SUELDO <- factor(df$TR_SUELDO,
                       levels = c("Menos de 700 euros",
                                  "De 700 a 999 euros",
                                  "De 1.000 a 1.499 euros",
                                  "De 1.500 a 1.999 euros",
                                  "De 2.000 a 2.499 euros",
                                  "De 2.500 a 2.999 euros",
                                  "De 3.000 euros en adelante",
                                  "NS/NC"),
                       ordered = TRUE)

#verificamos results

print("Valores faltantes en TR_SUELDO después de la imputación (solo trabajando)")
sum(is.na(df$TR_SUELDO[df$TRBPRN1 == "Trabajando"]))

print("Frecuencia de niveles TR_SUELDO (en todo el dataset)")
print(summary(df$TR_SUELDO))

# visualizar los resultados pero !solo los trbajando 

ggplot(df %>% filter(TRBPRN1 == "Trabajando"),
       aes(x = RAMA, fill = TR_SUELDO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribución de niveles salariales",
    x = "Rama de estudio",
    y = "Proporción dentro de cada rama",
    fill = "Nivel salarial"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#calcular cuántos valores se imputaron los na
imputaciones_por_rama <- df %>%
  filter(TRBPRN1 == "Trabajando") %>%
  group_by(RAMA) %>%
  summarise(
    Total_Registros = n(),
    Faltantes = sum(is.na(TR_SUELDO)),
    Completos = Total_Registros - Faltantes
  ) %>%
  mutate(
    Porcentaje_Completos = round((Completos / Total_Registros) * 100, 2)
  )

# unir tablas
resumen_imputacion <- left_join(moda_por_rama, imputaciones_por_rama, by = "RAMA")
print(resumen_imputacion)

```

Con el propósito de examinar la distribución de las variables *RAMA* y *TR_SUELDO* tras la imputación, se genera una tabla de contingencia. El resultado respalda la correcta aplicación del método de imputación por moda y evidencia que la variable *TR_SUELDO* quedó adecuadamente estructurada.

```{r}
table(df$RAMA, df$TR_SUELDO, useNA = "ifany")

```


# Gráficas



Gráfica de la variación del sueldo según la rama de de estudio

```{r}
ggplot(df %>% filter(TRBPRN1 == "Trabajando"), aes(x = RAMA, fill = TR_SUELDO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Variación del sueldo según la rama de estudio",
    x = "Rama de estudio",
    y = "Proporción de cada nivel salarial",
    fill = "Nivel salarial"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))


```

Gráfica de distribución de hombres y mujeres en cada rama de estudio

```{r}
ggplot(df, aes(x = RAMA, fill = SEXO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribución de mujeres y hombres por rama de estudio",
    x = "Rama de estudio",
    y = "Proporción",
    fill = "Sexo"
  ) +
  scale_fill_manual(values = c("#4169E1", "#FFC0CB")) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

```
Gráfica de comparación salarial según sexo

```{r}
ggplot(df %>% filter(TRBPRN1 == "Trabajando"), aes(x = SEXO, fill = TR_SUELDO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Diferencia salarial según el sexo",
    x = "Sexo",
    y = "Proporción de niveles salariales",
    fill = "Nivel salarial"
  ) +
  scale_fill_brewer(palette = "Purples") +
  theme_minimal()

```

Gráfica de distribución salarial por tipo de universidad

```{r}

ggplot(df %>% filter(TRBPRN1 == "Trabajando", !is.na(T_UNIV), !is.na(TR_SUELDO)),
       aes(x = T_UNIV, fill = TR_SUELDO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribución salarial por tipo de universidad",
    x = "Tipo de universidad",
    y = "Proporción de niveles salariales",
    fill = "Nivel salarial"
  ) +
  scale_fill_brewer(palette = "Reds") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))

```
Gráfica de relación entre número de estudios y rango salarial

```{r}

df$IDIOMAS <- factor(df$IDIOMAS,
                     levels = c("1", "2", "3", "4", "5 o más"),
                     labels = c("Un estudio", "Dos estudios", "Tres", "Cuatro", "Cinco o más"),
                     ordered = TRUE)

ggplot(df_plot %>% filter(TRBPRN1 == "Trabajando", !is.na(IDIOMAS), !is.na(TR_SUELDO)),
       aes(x = IDIOMAS, fill = TR_SUELDO)) +
  geom_bar(position = "fill") +
  labs(
    title = "Distribución salarial según Nº idiomas",
    subtitle = "Solo personas que se encuentran trabajando",
    x = "Número de idiomas",
    y = "Proporción dentro de cada categoría",
    fill = "Nivel salarial"
  ) +
  scale_fill_brewer(palette = "Greens") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
        plot.title = element_text(face = "bold"))

```


























